# 音频播放器 (Audio Player)

这是一个使用 Rust 编写的音频播放器程序，支持多种音频格式的播放。

## 功能特性

- 🎵 支持多种音频格式：MP3、AAC、ISO MP4
- 🔊 使用 `symphonia` 库进行音频解码
- 🎛️ 使用 `cpal` 库进行音频输出
- 📱 支持设备选择和管理
- 🎼 支持音频文件元数据显示
- ⏱️ **音频时长计算** - 自动计算并显示音频文件的播放时长
- 📋 **音频信息查看** - 不播放音频即可查看文件信息
- 🎧 **真正的音频播放** - 解码后的音频数据通过环形缓冲区传递到音频输出设备

## 依赖项

- `symphonia` - 音频解码库
- `cpal` - 跨平台音频库
- `clap` - 命令行参数解析库

## 编译和运行

### 编译程序

```bash
cargo build --release
```

### 运行程序

#### 列出可用的音频设备

```bash
cargo run -- --list-devices
```

#### 播放音频文件

```bash
cargo run -- path/to/your/audio/file.mp3
```

#### 指定音频设备播放

```bash
cargo run -- --device 0 path/to/your/audio/file.mp3
```

#### 查看音频文件信息（不播放）

```bash
cargo run -- --info path/to/your/audio/file.mp3
```

#### 查看帮助信息

```bash
cargo run -- --help
```

## 支持的音频格式

- **MP3** - MPEG Audio Layer III
- **AAC** - Advanced Audio Coding
- **ISO MP4** - ISO Base Media File Format

## 使用示例

```bash
# 播放 MP3 文件
cargo run -- song.mp3

# 播放 AAC 文件
cargo run -- song.aac

# 播放 MP4 音频文件
cargo run -- song.mp4

# 使用指定设备播放
cargo run -- --device 4 song.mp3

# 查看音频文件信息和时长（不播放）
cargo run -- --info song.mp3

# 查看音频文件的详细信息
cargo run -- -i song.mp3
```

## 音频信息功能

使用 `--info` 或 `-i` 选项可以查看音频文件的详细信息，包括：

- 文件路径和格式
- 音频时长（HH:MM:SS.mmm 格式）
- 采样率（Hz）
- 声道数
- 位深度（如果可用）
- 总帧数（如果可用）
- 元数据（标题、艺术家、专辑等）

示例输出：
```
File: song.mp3
Metadata:
  Title: "My Song"
  Artist: "Artist Name"
  Album: "Album Name"
Duration: 03:45.123
Audio info: 2 channels, 44100 Hz
Bits per sample: 16
Total frames: 9945600
```

## 程序结构

- `main.rs` - 主程序入口
- `play_audio()` - 音频播放功能
- `get_audio_info()` - 音频信息获取功能
- `calculate_audio_duration()` - 音频时长计算功能
- `format_duration()` - 时长格式化功能
- `list_audio_devices()` - 设备列表功能
- `create_stream()` - 音频流创建功能
- `write_audio_buffer()` - 音频缓冲区写入功能

## 音频播放架构

程序采用多线程架构实现真正的音频播放：

1. **主线程** - 负责用户界面和程序控制
2. **解码线程** - 独立线程负责音频解码，将解码后的数据写入共享缓冲区
3. **音频输出线程** - 由 `cpal` 库管理的回调线程，从共享缓冲区读取数据并输出到音频设备

### 数据流程

```
音频文件 → symphonia解码器 → 格式转换 → 共享缓冲区 → cpal音频流 → 音频设备
```

- 使用 `VecDeque<f32>` 作为音频缓冲区，支持高效的先进先出操作
- 支持多种音频格式的自动转换（U8, U16, U32, S8, S16, S32, F32）
- 自动处理通道数匹配和采样率适配

## 支持的音频输出格式

程序现在支持以下所有 cpal 音频输出格式：

- **整数格式**：I8, U8, I16, U16, I32, U32, I64, U64
- **浮点格式**：F32, F64

这意味着程序可以与几乎所有类型的音频设备兼容，包括：

- 基本音频设备（通常使用 I16 或 U8）
- 专业音频设备（通常使用 I32 或 F32）
- 高端音频设备（可能使用 F64）
- 老旧设备（可能使用 U8 或 I8）

## 注意事项

1. 确保您的系统有可用的音频输出设备
2. 确保音频文件格式受支持
3. 程序会自动检测文件格式并选择合适的解码器

## 故障排除

如果遇到音频播放问题，请：

1. 检查 `--list-devices` 输出中是否有可用设备
2. 尝试使用不同的音频设备索引
3. 确认音频文件格式支持
4. 检查系统音频服务是否正常运行

## 更新日志

### v0.3.0 - 音频时长计算功能

- ✅ **新增时长计算**：自动计算并显示音频文件的播放时长
- ✅ **音频信息查看**：新增 `--info` 选项，无需播放即可查看文件信息
- ✅ **时长格式化**：支持 HH:MM:SS.mmm 格式的时长显示
- ✅ **改进的时长计算**：支持基于时间基准和采样率的精确计算
- ✅ **更多音频信息**：显示位深度、总帧数等详细信息

### v0.2.1 - 完整的音频格式支持

- ✅ **新增格式支持**：添加对 U8、I8、I32、U32、F64、I64、U64 等音频格式的支持
- ✅ **设备兼容性**：现在支持更多种类的音频设备和它们的原生格式
- ✅ **更好的错误提示**：显示具体的不支持格式信息

### v0.2.0 - 真正的音频播放

- ✅ **修复重要问题**：解码后的音频数据现在真正传递给音频输出设备
- ✅ 实现多线程音频播放架构
- ✅ 添加音频缓冲区管理
- ✅ 支持多种音频格式的自动转换
- ✅ 改进通道数和采样率适配

## 许可证

本项目采用 MIT 许可证。 